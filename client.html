<!DOCTYPE html>
<html>
   <head>
      <script src="/socket.io/socket.io.js"></script>

   </head>
   <body>
      
      <input type="text" id="userNameInput"/>
      <button onclick="setUsername()">Login</button>

      
      <input type="text" placeholder="Room Name" id="createRoom"/>
      <input type="text" placeholder = "Room Password" id="password"/>
      <button id = "createRoomButton"  onclick="createRoom()">Create Chat Room</button>

      <button type="submit" id="seeRooms" onclick = "displayRooms()">See rooms</button>
      <div id="roomListDisplay"></div>

      <input type="text" id="message_input"/>
      <button  id = "send" onclick="sendMessage()">send</button>



      <div id="chatlog"></div>
   </body>
</html>


<script type ="text/javascript">
   var displayedRooms = [];
   var usersToRooms = {};


   initializeWebpage();

   function initializeWebpage(){
      document.getElementById('message_input').style.display = "none";
      document.getElementById('send').style.display = "none";
      document.getElementById('createRoom').style.display = "none";
      document.getElementById('password').style.display = "none";
      document.getElementById('createRoomButton').style.display = "none";
      document.getElementById('seeRooms').style.display = "none";

   }

   function setUsername(){
      username = document.getElementById('userNameInput').value;
      socketio.emit("username_to_server", {user:username});
      
   }

   function findRoomForUser(userName) {
         for (const roomName in usersToRooms) {
                  const room = usersToRooms[roomName];
               if (room.user.includes(userName)) {
               return roomName;
            }
         }

      }



   function sendMessage(){
      var msg = document.getElementById("message_input").value;
      var user = document.getElementById('userNameInput').value;
      var roomName = findRoomForUser(user)
      
      socketio.emit("message_to_server", {message:msg, room:roomName, user:user});
   }


   function createRoom(){
      const roomName = document.getElementById("createRoom").value;
      const password = document.getElementById("password").value;
      const userName = document.getElementById("userNameInput").value;
      socketio.emit("create_room", { nameOfRoom: roomName, userName: userName, chatroomPassword: password });
      displayRooms();
   }

   function displayRooms(){
      socketio.emit("get_rooms_from_server", {message:""});
   }
   function joinRoom(roomToJoin){
      const userName = document.getElementById("userNameInput").value;
      if (usersToRooms[roomToJoin].password != ""){
         const password = prompt("Enter room password:");
         socketio.emit('joinRoom', {roomName: roomToJoin, user:userName, password: password })

      }
      else{
         socketio.emit('joinRoom', {roomName: roomToJoin, user:userName, password: "" })

      } 
   }



   //////////////////////////////socket work //////////////////////////////////////////////////
   var socketio = io.connect();
   socketio.on("message_to_client",function(data) {
      //Append an HR thematic break and the escaped HTML of the new message
      var room = data['room'];
      var user = data['user'];
      var msg = data['message'];
      console.log(data);

      document.getElementById("chatlog").appendChild(document.createElement("hr"));
      document.getElementById("chatlog").appendChild(document.createTextNode(user +": " + msg));
   });


   socketio.on("loginError",function(data) {
      //display error message
      alert(data['message']);
   });
   socketio.on("roomNameError",function(data) {
      //display error message
      alert(data['message']);
   });

   socketio.on("give_rooms_to_client",function(data) {
      usersToRooms = data['usersToRooms'];
      console.log(JSON.stringify(usersToRooms) + "UTR");
      rooms = data['allRooms'];
      console.log(rooms);
      for (const i in rooms) {
         if (!displayedRooms.includes(rooms[i])) {
            let currentRoom = rooms[i];
            displayedRooms.push(rooms[i]);
            let newRoom = document.createElement("button");
            newRoom.innerHTML = currentRoom;
            newRoom.setAttribute("id", currentRoom)
            newRoom.addEventListener("click", function () {
               joinRoom(currentRoom);
            });
            let roomList = document.getElementById("roomListDisplay");
            roomList.appendChild(newRoom);
         }

      }
   });
   
   socketio.on("successfulLogin",function(data) {
      document.getElementById('createRoom').style.display = "inline-block";
      document.getElementById('password').style.display = "inline-block";
      document.getElementById('createRoomButton').style.display = "inline-block";
      document.getElementById('seeRooms').style.display = "inline-block";



      });

      
   socketio.on("userJoinedRoom",function(data) {
         console.log(JSON.stringify(usersToRooms));
         console.log(data);
      document.getElementById('message_input').style.display = "inline-block";
      document.getElementById('send').style.display = "inline-block";
      var user = data['user'];
      var roomName = data['room'];
      usersToRooms[roomName].user.push(user);
      });





   </script>